<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©sultats d'Analyse</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 2rem; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #14f195; text-align: center; }
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin: 1rem 0 2rem; }
        .nav-link { color: #14f195; text-decoration: none; font-size: 1.1rem; }
        .btn-main-trade { padding: 10px 20px; background-color: #8A2BE2; color: white; font-weight: bold; text-decoration: none; border-radius: 8px; transition: transform 0.2s ease, background-color 0.2s ease; }
        .btn-main-trade:hover { background-color: #7b24cb; transform: scale(1.05); }
        .results-grid { display: grid; grid-template-columns: 1fr; gap: 2.5rem; }
        .result-card { background-color: #1e1e1e; padding: 1.5rem 2rem; border-radius: 12px; opacity: 0.5; transition: opacity 0.5s; }
        .card-header { margin-bottom: 1.5rem; border-bottom: 1px solid #333; padding-bottom: 1rem; min-height: 50px; }
        .card-header h2 { margin: 0; font-size: 1.8rem; display: inline-block; }
        .card-header .symbol { font-size: 1.2rem; color: #888; margin-left: 10px; }
        .error { color: #dc3545; font-weight: bold; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-box, .analysis-box, .tools-box { background-color: #2a2a2a; padding: 1rem; border-radius: 8px; }
        .stat-box strong, .tools-box strong { color: #888; display: block; font-size: 0.9em; margin-bottom: 5px; text-transform: uppercase; }
        .stat-box p { margin: 0; font-size: 1.8rem; color: #fff; min-height: 29px; }
        .analysis-box h3 { margin-top: 0; font-size: 1.2rem; }
        .analysis-box ul { padding-left: 20px; margin: 10px 0 0; color: #ccc; font-size: 0.9em;}
        .signal.buy { color: #28a745; } .signal.hold { color: #ffc107; } .signal.wait { color: #dc3545; }
        .tools-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 1rem; }
        .btn { display: block; color: white; text-align: center; padding: 10px; border-radius: 8px; text-decoration: none; font-weight: bold; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn-axiom-specific { background-color: #8A2BE2; } .btn-solscan { background-color: #1a5c8b; } .btn-rugcheck { background-color: #c79500; }
        .chart-container { height: 550px; }
        iframe { border: none; width: 100%; height: 100%; border-radius: 8px; }
        .loader { text-align: center; padding: 2rem; font-size: 1.2rem; color: #888; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìà R√©sultats d'Analyse</h1>
        <div class="top-nav">
            <a href="/" class="nav-link">‚Üê Nouvelle Analyse</a>
            <a href="https://axiom.trade/@math96826" target="_blank" class="btn-main-trade">TRADER AVEC AXIOM</a>
        </div>
        <div class="results-grid">
            {% for token in tokens %}
            <div class="result-card" id="card-{{ loop.index0 }}">
                <div class="card-header">
                    <h2>Analyse en cours...</h2>
                    <span class="symbol">{{ token[:6] }}...</span>
                </div>
                <div class="loader">Chargement des donn√©es...</div>
                <div class="content-wrapper" style="display: none;">
                    </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        // La liste des tokens est pass√©e directement par le serveur Python
        const tokensToAnalyze = {{ tokens|tojson|safe }};

        // --- Fonctions de formatage (inchang√©es) ---
        const formatPrice = (value) => {
            if (value < 0.000001) return `$${Number(value).toFixed(10)}`;
            return `$${Number(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 8 })}`;
        };
        const formatMarketCap = (value) => {
            if (value > 1_000_000_000) return `$${(value / 1_000_000_000).toFixed(2)}B`;
            if (value > 1_000_000) return `$${(value / 1_000_000).toFixed(2)}M`;
            if (value > 1_000) return `$${(value / 1_000).toFixed(2)}K`;
            return `$${Math.round(value)}`;
        };

        // --- Logique d'analyse strat√©gique (traduite en JavaScript) ---
        function analyzeTokenStrategy(pairData) {
            let reasons = [];
            const now = Date.now();
            
            const liquidity = pairData.liquidity?.usd || 0;
            if (liquidity < 3000) {
                return { signal: "Risque √âlev√©", signal_key: "wait", reasons: ["üö© Liquidit√© critique (< 3k$)"] };
            }
            
            const pairCreatedAt = pairData.pairCreatedAt || 0;
            if ((now - pairCreatedAt) < 3600 * 1000) {
                reasons.push("‚ö†Ô∏è Token tr√®s r√©cent (< 1h)");
            }

            let score = 0;
            const priceChange = pairData.priceChange || {};
            if (priceChange.h1 > 15) { score++; reasons.push("üìà Momentum 1h (> +15%)"); }
            if (priceChange.h24 > 0) { score++; reasons.push("‚úÖ Tendance 24h positive"); }
            if (priceChange.m5 < -10) { score--; reasons.push("üìâ Dump r√©cent 5min (< -10%)"); }
            
            const volume = pairData.volume || {};
            if (volume.h24 > 50000) { score++; reasons.push("üìä Volume 24h significatif (> 50k$)"); }

            const txns = pairData.txns?.h1 || {};
            const buys = txns.buys || 0;
            const sells = txns.sells || 0;
            if (buys > sells * 1.5) { score += 2; reasons.push("üî• Forte pression acheteuse 1h"); }
            else if (buys > sells) { reasons.push("üëç Sentiment acheteur positif 1h"); }

            const fdv = pairData.fdv || 0;
            if (fdv < 250000 && fdv > 10000) { score++; reasons.push("üíé Potentiel (MC < 250k$)"); }

            if (score >= 4) return { signal: "Signal d'Achat Fort", signal_key: "buy", reasons };
            if (score >= 2) return { signal: "Potentiel Int√©ressant", signal_key: "hold", reasons };
            if (score >= 0) return { signal: "Neutre / √Ä Surveiller", signal_key: "hold", reasons };
            return { signal: "Prudence Requise", signal_key: "wait", reasons };
        }

        // --- Fonction principale qui appelle l'API et met √† jour la page ---
        async function fetchAndDisplayData(tokenAddress, cardIndex) {
            const card = document.getElementById(`card-${cardIndex}`);
            const loader = card.querySelector('.loader');
            
            try {
                const response = await fetch(`https://api.dexscreener.com/latest/dex/search?q=${tokenAddress}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (!data.pairs || data.pairs.length === 0) {
                    throw new Error("Token non trouv√©.");
                }

                const pairData = data.pairs[0];
                const analysis = analyzeTokenStrategy(pairData);
                
                // Remplissage du contenu de la carte
                card.querySelector('.card-header h2').textContent = pairData.baseToken.name;
                card.querySelector('.card-header .symbol').textContent = `$${pairData.baseToken.symbol}`;
                
                const contentWrapper = `
                    <div class="info-grid">
                        <div class="stat-box"><strong>Prix Actuel (USD)</strong><p>${formatPrice(pairData.priceUsd)}</p></div>
                        <div class="stat-box"><strong>Market Cap (FDV)</strong><p>${formatMarketCap(pairData.fdv)}</p></div>
                        <div class="analysis-box">
                            <h3 class="signal ${analysis.signal_key}">${analysis.signal}</h3>
                            <ul>${analysis.reasons.map(r => `<li>${r}</li>`).join('')}</ul>
                        </div>
                        <div class="tools-box">
                            <strong>Outils d'Analyse</strong>
                            <div class="tools-buttons">
                                <a href="https://axiom.trade/t/${pairData.baseToken.address}/@math96826" target="_blank" class="btn btn-axiom-specific">Trader ce Token</a>
                                <a href="https://solscan.io/token/${pairData.baseToken.address}" target="_blank" class="btn btn-solscan">Explorer sur Solscan</a>
                                <a href="https://rugcheck.xyz/tokens/${pairData.baseToken.address}" target="_blank" class="btn btn-rugcheck">Analyser sur RugCheck</a>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <iframe src="https://dexscreener.com/solana/${pairData.pairAddress}?embed=1&theme=dark&info=0"></iframe>
                    </div>
                `;
                
                const wrapper = card.querySelector('.content-wrapper');
                wrapper.innerHTML = contentWrapper;
                wrapper.style.display = 'block';
                loader.style.display = 'none';
                card.style.opacity = 1;

            } catch (error) {
                console.error("Erreur de fetch:", error);
                loader.innerHTML = `<div class="error">Erreur : ${error.message}</div>`;
                card.style.opacity = 1;
            }
        }

        // Lance une analyse pour chaque token demand√©
        tokensToAnalyze.forEach((token, index) => {
            fetchAndDisplayData(token, index);
        });
    });
    </script>
</body>
</html>