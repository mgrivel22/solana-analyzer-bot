<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©sultats d'Analyse</title>
    <style>
        :root { /* Couleurs */
            --primary-color: #14f195; --background-color: #121212; --surface-color: #1e1e1e;
            --text-color: #e0e0e0; --secondary-text-color: #888; --axiom-purple: #8A2BE2;
            --score-bad: #dc3545; --score-medium: #ffc107; --score-good: #28a745;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 2rem; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: var(--primary-color); text-align: center; }
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin: 1rem 0 2rem; }
        .nav-link { color: var(--primary-color); text-decoration: none; font-size: 1.1rem; }
        .btn-main-trade { padding: 10px 20px; background-color: var(--axiom-purple); color: white; font-weight: bold; text-decoration: none; border-radius: 8px; transition: all 0.2s; }
        .btn-main-trade:hover { background-color: #7b24cb; transform: scale(1.05); }
        .result-card { background-color: var(--surface-color); padding: 1.5rem 2rem; border-radius: 12px; }
        .card-header { margin-bottom: 1.5rem; border-bottom: 1px solid #333; padding-bottom: 1rem; }
        .card-header h2 { margin: 0; font-size: 1.8rem; display: inline-block; }
        .card-header .symbol { font-size: 1.2rem; color: var(--secondary-text-color); margin-left: 10px; }
        .error { color: var(--score-bad); font-weight: bold; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-box, .analysis-box, .tools-box { background-color: #2a2a2a; padding: 1rem; border-radius: 8px; }
        .stat-box strong, .tools-box strong { color: var(--secondary-text-color); display: block; font-size: 0.9em; margin-bottom: 5px; text-transform: uppercase; }
        .stat-box p { margin: 0; font-size: 1.5rem; color: #fff; }
        .tools-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 1rem; }
        .btn { display: block; color: white; text-align: center; padding: 10px; border-radius: 8px; text-decoration: none; font-weight: bold; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn-axiom-specific { background-color: var(--axiom-purple); } .btn-solscan { background-color: #1a5c8b; } .btn-rugcheck { background-color: #c79500; }
        .score-card { background-color: #2a2a2a; padding: 1.5rem; border-radius: 8px; text-align: center; }
        .score-card h3 { margin-top: 0; font-size: 1.1rem; color: var(--secondary-text-color); }
        .score-value { font-size: 3rem; font-weight: bold; margin: 0.5rem 0; }
        .ai-verdict-card { grid-column: 1 / -1; border: 2px solid var(--primary-color); }
        .ai-verdict-card .verdict { font-size: 2.5rem; font-weight: bold; }
        .verdict-BUY-NOW, .verdict-POTENTIAL-BUY { color: var(--score-good); } .verdict-HOLD { color: var(--score-medium); } .verdict-WAIT, .verdict-HIGH-RISK { color: var(--score-bad); }
        .ai-summary { font-style: italic; font-size: 0.9em; color: #ccc; margin-top: 10px; }
        .loader { text-align: center; padding: 2rem; font-size: 1.2rem; color: #888; }
        .chart-container { height: 550px; margin-top: 2rem; }
        iframe { border: none; width: 100%; height: 100%; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Analyse IA & Scoring Avanc√©</h1>
        <div class="top-nav">
    <a href="/" class="nav-link">‚Üê Nouvelle Analyse</a>
    <a href="/tendances" class="nav-link">Tendances üî•</a>
    <a href="https://axiom.trade/@math96826" target="_blank" class="btn-main-trade">TRADER AVEC AXIOM</a>
    </div>
        {% for token in tokens %}
        <div class="result-card" id="card-{{ loop.index0 }}">
            <div class="card-header"><h2>Analyse en cours...</h2><span class="symbol">{{ token[:6] }}...</span></div>
            <div class="loader">√âtape 1/2 : R√©cup√©ration des donn√©es de march√©...</div>
            <div class="content-wrapper" style="display: none;"></div>
        </div>
        {% endfor %}
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        const tokensToAnalyze = {{ tokens|tojson|safe }};

        const formatPrice = (value) => `$${Number(value).toLocaleString('en-US',{minimumFractionDigits:2, maximumFractionDigits:10})}`;
        const formatMarketCap = (value) => {
            if (value > 1e9) return `$${(value / 1e9).toFixed(2)}B`;
            if (value > 1e6) return `$${(value / 1e6).toFixed(2)}M`;
            if (value > 1e3) return `$${(value / 1e3).toFixed(2)}K`;
            return `$${Math.round(value)}`;
        };

        async function processToken(tokenAddress, cardIndex) {
            const card = document.getElementById(`card-${cardIndex}`);
            const loader = card.querySelector('.loader');
            const wrapper = card.querySelector('.content-wrapper');

            try {
                // √âtape 1: Le navigateur r√©cup√®re les donn√©es publiques de DexScreener
                const dexResponse = await fetch(`https://api.dexscreener.com/latest/dex/search?q=${tokenAddress}`);
                if (!dexResponse.ok) throw new Error('API DexScreener indisponible');
                const dexData = await dexResponse.json();
                if (!dexData.pairs || dexData.pairs.length === 0) throw new Error('Token non trouv√© sur DexScreener');
                const pairData = dexData.pairs[0];

                loader.textContent = '√âtape 2/2 : Analyse par l\'IA sur le serveur...';

                // √âtape 2: On envoie les donn√©es √† notre serveur pour l'analyse compl√®te
                const analysisResponse = await fetch(`/api/get_final_analysis`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ dex_data: pairData, token_address: tokenAddress })
                });
                if (!analysisResponse.ok) throw new Error('Le serveur d\'analyse a retourn√© une erreur');
                const analysisData = await analysisResponse.json();
                
                // √âtape 3: On affiche le tableau de bord complet
                card.querySelector('.card-header h2').textContent = pairData.baseToken.name;
                card.querySelector('.card-header .symbol').textContent = `$${pairData.baseToken.symbol}`;
                
                const scoreColor = analysisData.total_score < 40 ? 'var(--score-bad)' : (analysisData.total_score < 70 ? 'var(--score-medium)' : 'var(--score-good)');
                const verdictClass = analysisData.ai_analysis.final_verdict.replace(/\s+/g, '-');

                wrapper.innerHTML = `
                    <div class="info-grid">
                        <div class="stat-box"><strong>Prix Actuel</strong><p>${formatPrice(pairData.priceUsd)}</p></div>
                        <div class="stat-box"><strong>Market Cap</strong><p>${formatMarketCap(pairData.fdv)}</p></div>
                        <div class="score-card">
                            <h3>Score Global</h3>
                            <p class="score-value" style="color:${scoreColor};">${Math.round(analysisData.total_score)}/100</p>
                        </div>
                        <div class="tools-box">
                            <strong>Outils</strong>
                            <div class="tools-buttons">
                                <a href="https://axiom.trade/t/${pairData.baseToken.address}/@math96826" target="_blank" class="btn btn-axiom-specific">Trader ce Token</a>
                                <a href="https://solscan.io/token/${pairData.baseToken.address}" target="_blank" class="btn btn-solscan">Explorer</a>
                                <a href="https://rugcheck.xyz/tokens/${pairData.baseToken.address}" target="_blank" class="btn btn-rugcheck">Rapport S√©curit√©</a>
                            </div>
                        </div>
                    </div>
                    <div class="score-card ai-verdict-card">
                        <h3>Verdict de l'IA</h3>
                        <p class="score-value verdict-${verdictClass}">${analysisData.ai_analysis.final_verdict}</p>
                        <p><strong>Probabilit√© de hausse : ${analysisData.ai_analysis.probability}%</strong></p>
                        <p class="ai-summary">"${analysisData.ai_analysis.summary}"</p>
                    </div>
                    <div class="chart-container">
                        <iframe src="https://dexscreener.com/solana/${pairData.pairAddress}?embed=1&theme=dark&info=0"></iframe>
                    </div>
                `;
                
                wrapper.style.display = 'block';
                loader.style.display = 'none';

            } catch (error) {
                console.error("Erreur de traitement:", error);
                loader.innerHTML = `<div class="error">Erreur : ${error.message}</div>`;
            }
        }

        tokensToAnalyze.forEach((token, index) => {
            processToken(token, index);
        });
    });
    </script>
</body>
</html>